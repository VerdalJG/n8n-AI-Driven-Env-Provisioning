name: Build & Deploy Docker for Dev

on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches: [dev/*]

jobs:
  docker-build-deploy:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}

    steps:
      # ---------- 1. Checkout repo ----------
      - name: Checkout repository
        uses: actions/checkout@v5.0.1

      # ---------- 2. Find latest relevant issue ----------
      - name: Get Latest Issue for Current Pusher
        id: extract_issue
        run: |
          PUSHER=${GITHUB_ACTOR}

          # Find latest open issue by this user with automation-completed label
          ISSUE_NUMBER=$(gh issue list \
            --repo $GITHUB_REPOSITORY \
            --label "automation-completed" \
            --author "$PUSHER" \
            --state open \
            --json number,createdAt \
            --jq 'sort_by(.createdAt) | reverse | .[0].number')

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "No matching issue found for user $PUSHER"
            exit 1
          fi

          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "Found issue #$ISSUE_NUMBER for $PUSHER"

      # ---------- 3. Get EC2 IP from issue comments ----------
      - name: Get EC2 IP
        id: get_ec2_ip
        run: |
          ISSUE_NUMBER=${{ steps.extract_issue.outputs.issue_number }}

          EC2_IP=$(gh issue view $ISSUE_NUMBER --repo $GITHUB_REPOSITORY --json comments \
            | jq -r '.comments[] | select(.body|test("EC2 public IP")) | .body | capture("EC2 public IP: (?<ip>.*)").ip')

          if [ -z "$EC2_IP" ]; then
            echo "No EC2 IP found in issue #$ISSUE_NUMBER comments"
            exit 1
          fi

          echo "ec2_ip=$EC2_IP" >> $GITHUB_OUTPUT
          echo "EC2 IP: $EC2_IP"

      # ---------- 4. Set up Docker ----------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # ---------- 5. Build & push Docker image ----------
      - name: Build and Push Docker Image
        run: |
          ISSUE_NUMBER=${{ steps.extract_issue.outputs.issue_number }}
          IMAGE_NAME="verdalvc/n8n-pss-dev-app:issue-$ISSUE_NUMBER"

          docker build -t $IMAGE_NAME .
          docker push $IMAGE_NAME

      # ---------- 6. Deploy Docker container to EC2 ----------
      - name: Deploy Docker container to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ steps.get_ec2_ip.outputs.ec2_ip }}
          username: ubuntu
          key: ${{ secrets.EC2_GITHUB_RUNNER_PRIVATE_KEY }}
          script: |
            ISSUE_NUMBER=${{ steps.extract_issue.outputs.issue_number }}
            IMAGE_NAME="verdalvc/n8n-pss-dev-app:issue-$ISSUE_NUMBER"

            # Stop and remove previous container if exists
            sudo docker stop issue-$ISSUE_NUMBER || true
            sudo docker rm issue-$ISSUE_NUMBER || true

            # Run the new container
            sudo docker run -d \
              --name issue-$ISSUE_NUMBER \
              -p 8080:80 \
              $IMAGE_NAME
